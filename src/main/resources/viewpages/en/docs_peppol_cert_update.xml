<!--

    Copyright (C) 2014-2019 Philip Helger (www.helger.com)
    philip[at]helger[dot]com

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<p>
  This article tries to give an overview over the steps necessary to perform a
  certificate update in the PEPPOL network.
  It is suggested to read <a href="/public/menuitem-docs-peppol-pki">the introduction to
  the PEPPOL PKI</a> before continuing here.
</p>


<div class="card">
  <div class="card-header">Table of contents</div>
  <div class="card-body">
    <ol>
      <li><a href="#bg">Background information</a></li>
      <li><a href="#ap">Updating an Access Point (AP)</a></li>
      <li><a href="#smp">Updating an SMP</a>
        <ol>
          <li><a href="#smpsml">Notifying the SML</a></li>
          <li><a href="#smpitself">Updating the SMP software</a></li>
        </ol>
      </li>
    </ol>
  </div>
</div>

<a name="bg"></a>
<h2>Background information</h2>

<p>
  Short note: the information provided here is meant to be as product independent as possible, 
  so if you have tool specific questions, please contact your vendor directly. 
</p>

<p>
  Another note: for an AP certificate update you must make sure to update the certificate in your Access Point software
  <strong>and</strong> in all SMP entries that point to your AP.
  For an SMP certificate update, you only need to update your SMP software.
</p>

<p>
  The terminology in this article differentiates between <em>keystore</em> and <em>truststore</em>.
  A <em>keystore</em> is considered the collection of your private keys that might <b>not</b> be
  disclosed to the public.
  <br />
  A <em>truststore</em> on the contrary is a collection of public certificates that are
  trustworthy.
  Usually an application has one <em>keystore</em> and one <em>truststore</em>.
  Both types can contain different private keys and/or public certificates, that are accessed by
  so called <em>alias</em>es.
  Both <em>keystore</em> and <em>truststore</em> usually require a password to access it.
  Additionally each key entry (alias) can have it's own password, that may be different from the
  password to access the file. 
  <br />
  PEPPOL does not provide a common <em>truststore</em>, but I assembled some common <em>truststores</em>
  that can be found at 
  <a href="https://github.com/phax/peppol-commons/tree/master/peppol-commons/src/main/resources/truststore" target="_blank">https://github.com/phax/peppol-commons/tree/master/peppol-commons/src/main/resources/truststore</a>
  and try to serve different requirements.
  E.g. phoss-smp uses the <code>complete-truststore.jks</code> by default.
  <em>Truststores</em> are usually public and should not contain secret keys.
  Theoretically <em>keystore</em> and <em>truststore</em> can reside in the same file, but that is considered bad practice. 
</p>

<p>
  The PEPPOL PKI update that happened in 2018 was a special case of a certificate update, because it
  required to update the <em>truststore</em> as well, because a completely new PKI was introduced.
  Regular certificate updates only contain updates of <em>keystores</em>.
</p>

<a name="ap"></a>
<h2>Updating an Access Point</h2>

<a name="smp"></a>
<h2>Updating an SMP</h2>

<p>
  The certificate update on an SMP consists of two basic steps:
</p>
<ol>
  <li>notify the SML about your new certificate, ideally ahead of time</li> 
  <li>update the the SMP software itself</li>   
</ol>

<p>
  It's important that the SMP certificate contains the full chain together with the key, as a single alias
  in the <em>keystore</em>.
  <a href="https://github.com/phax/phoss-smp/wiki/Certificate-setup">phoss SMP Wiki</a> contains an explanation 
  how this can be achieved using commandline commands.
</p>

<a name="smpsml"></a>
<h3>Notifying the SML</h3>

<p>
  Updating the SML is mandatory - you <strong>must</strong> do this.<br />
  Note: remember to only use test SMP certificates with the SMK and production SMP certificates with the SML.
</p>

<p>
  The SML links your SMP-ID with your SMP certificate and your public endpoint URL.
  In case of a certificate update, the SML offers a special Webservice interface to indicate a future certificate change.
  This interface can only be used, if the certificate exchange happens in the future, and the date provided must at least
  be tomorrow (the day after the date of request). Additionally your existing certificate may not be expired yet.
  You can perform this certificate update request e.g. via <a href="/public/menuitem-tools-smp-sml">this site</a> but keep
  in mind that this requires your private key. Common SMP software like <a href="https://github.com/phax/phoss-smp">phoss SMP</a>
  contains this functionality "out of the box".<br />
  Note: the SML only needs the public certificate of your new SMP certificate - don't provide them with your private key!<br />
  Note: you need to manually update your SMP certificate in your SMP software at exactly the date you specified in that
  update request, otherwise you won't be able to perform changes in the SML.
</p>
<p>
  If your certificate is already expired, you need to contact <a href="/public/menuitem-docs-sml-support">CEF support</a>
  and provide the following information: old certificate subject and serial as well as new certificate subject and serial.<br />
  Note: you may already update your SMP software with the new certificate, because the old certificate is anyway useless.<br />
  Note: no further action or service call to the SML is necessary, if you are using this manual process.  
</p>

<a name="smpitself"></a>
<h3>Update the SMP software</h3>

<p>
  The update of your SMP certificate in your SMP software heavily depends on the software used.
  In most cases, the keystore is referenced in some kind of configuration file.
  Either you update that keystore or you configure a completely new keystore.<br />
  E.g. in <em>phoss-smp</em> the keystore is configured in two properties files:
  <code>smp-server.properties</code> and <code>pd-client.properties</code>. If you provide a new
  keystore, ensure to adopt the path in both files. A restart of the SMP web application is 
  required to make it work, if the path changed. After a certificate change it is recommended
  to visit the "Certificate information" page, to check if the modification was successful or not.
</p>

<p>
  Note: the SMP ID must <strong>not</strong> be changed during the update process. The SMP ID <strong>must never change</strong>.<br />
  Note: no special action is needed for PEPPOL Directory. All business card will be available, independent of the certificate status. 
</p>
